# 기말고사 준비

## Priority Ceiling Protocol

Priority Inheritance Protocol은 Priority Inversion 문제를 해결하지만, Deadlock과 Chained blocking 현상은 해결하지 못한다. 이러한 문제들은 Deadline missing을 일으킬 수 있는 문제들이다. Priority Ceiling Protocol은 이러한 문제를 해결할 수 있다.

### Semaphore ceiling, System ceiling

Priority Ceiling Protocol을 설명하기 위해서는 먼저 몇가지 용어를 정의해야 한다.

- Semaphore ceiling : 해당 세마포를 사용하는 테스크들 중 가장 높은 우선순위를 갖는 테스크의 우선순위 값. offline에 계산 할 수 있다.
- System ceiling : 다른 테스크에 의해서 lock이 걸린 세마포들의 ceiling 값 중 최대값(상한값). runtime에 계산될 수 있는 값이다.

### Priority ceiling protocol

어떤 테스크가 한 공유자원(세마포)를 lock하려고 할때, 그 시점에서의 system ceiling 값보다 테스크의 우선순위가 높지 않다면 blocking 되도록 한다. 이렇게 함으로써 Deadlock과 Chained blocking 현상을 해결할 수 있다.

## Rate-monotonic Scheduling

테스크들의 우선순위를 static하게 결정하는 경우, Rate-monotonic 방법으로 스케줄링 했을때, 가장 많은 테스크들이 feasible 함이 증명되었다. 그리고 Utilization bound test를 통과했을 경우 전체 system이 feasible 함이 밝혀졌다. 그러나 이 조건은 충분조건이기 때문에 이 조건을 만족시키지 못한다고 하여 system이 infeasible 한 것은 아니다. 필요충분조건은 다음과 같은 식을 통해 확인할 수 있다.

$$
W_i(t) = \sum_{j=1}^i C_j \lceil {t \over T_j} \rceil
$$

$$
L_i(t) = {W_i(t) \over t}
$$

$$
L_i = min_{(0<=t<=Ti)}\{L_i(t)\}
$$

$$
L = max_{(1<=i<=n)}\{L_i\}
$$

테스크 i가 feasible 하기 위해서는 Li <= 1 이어야 하고, 전체 system이 feasible 하기 위해서는 L <= 1 이어야 한다. Li 값을 계산할 때 모든 시점을 계산할 필요는 없고, 자신의 주기보다 작거나 같은 시간동안에, 자신보다 우선순위가 높거나 같은 테스크들의 주기의 배수 시점(Scheduling Point)에서만 검사하면 된다.

## 임베디드 보드 1

### ATmega 128

- RISC 구조 컴퓨터
- 128KB의 시스템 메모리, 4KB의 데이터 메모리
- 16 MIPS
- 53개의 GPIO 핀
- 8개의 외부 인터럽트 벡터

#### GPIO 핀

입력용, 출력용으로 사용할 수 있다. 먼저 핀을 입력으로 쓸것인지, 출력으로 쓸것인지 결정하고, 신호를 인가하거나, 읽을 수 있다. 이런 동작을 수행하기 위해서는 GPIO 핀과 대응하는 레지스터를 적절히 사용하면 된다.

- DDRx : 데이터 입출력 방향설정 레지스터
- PORTx : 핀을 출력용으로 사용할 경우, 이 레지스터에 데이터를 쓴다.
- PINx : 핀을 입력용으로 사용할 경우, 이 레지스터 값을 읽으면 현재 핀의 신호를 읽을 수 있다.

#### LED

Port A에 연결되어 있음.

> LED 사용 예제

```c
#include <avr/io.h>
#include <util/delay.h>
#define F_CPU 16000000UL

int main()
{
    DDRA = 0xff;

    while(1) {
        _delay_ms(1000);
        PORTA ^= 0xff;
    }

    return 0;
}
```

#### FND

7 개(점 포함 8개) 의 세그먼트로 이루어져 있다. np 접합 다이오드로 양 극단의 전위차를 걸면 빛을 발산한다. 양 극단은 핀의 길이차이로 구분한다. 다리가 긴쪽을 애노드(Anode, +), 다리가 짧은쪽을 캐소드(Cathode, -) 라고 부른다. FND는 8개의 세그먼트들의 애노드 다리나 캐소드 다리를 한꺼번에 연결하여 Vcc 또는 GND에 연결하고, 각 세그먼트의 개별 캐소드 다리나 애노드 다리에 적절한 신호를 주어서 빛을 발산하게 한다. 애노드 다리들을 한데 연결하면 애노드 공통(common), 캐소드 다리들을 한데 연결하면 케소드 공통(common)이라고 한다.

jkit-128-1 에는 총 4개의 FND가 붙어있다. 한번에 하나의 FND만 켤 수 있기 때문에, 4개의 FND를 빠르게 번갈아가며 키면서 4개가 동시에 켜진것처럼 보이도록 한다.

Jkit-128-1에 FND는 Port C에 연결되어 있다. 또한 어느 FND가 켜질 것인지 선택하는 selection 비트로 Port G의 하위 4개의 비트가 사용된다.

#### 스위치

jkit-128-1의 스위치 2개는 Port E의 4번, 5번 핀에 연결되어 있다. 스위치를 눌렀을 때 해당 핀에 0이 인가된다(pull-up 저항이 세팅되었기 때문). 스위치가 눌렸을때 이를 처리하는 방법은 폴링과 인터럽트 2가지 방식이 존재한다. 폴링 방식은 반복을 돌면서 계속 해당 핀의 상태를 조사하는 방법이다. 스위치가 눌렸는지 체크하기 위해서 계속해서 반복문을 실행해야 하는 낭비가 있다. 인터럽트 방식을 사용하면 스위치가 눌리지 않았을 때는 다른 일을 수행하고, 스위치가 눌린경우 곧바도 처리를 할 수 있다. 인터럽트 방식으로 입력을 처리하기 위해서는 먼저 인터럽트 서비스 루틴을 등록해야한다.

```c
ISR(INT_vect4) {

}

ISR(INT_vect5) {

}
```

Port E의 4번, 5번 핀은 INT4, INT5 신호에 연결되어 있다. 이를 활용해서 인터럽트를 처리하기 위해서는 EIMSK, EICRA, SREG 값을 적절하게 설정해주어야 한다.

- SREG : 7번째 비트를 1로 설정해주어 전체 인터럽트를 허용한다.
- EICRA, EICRB : 인터럽트의 트리거를 설정한다. 트리거란 인터럽트를 어느 시점에 발생시킬지에 대한 정의이다. falling edge trigger는 신호가 1에서 0으로 떨어질때, rising edge trigger는 신호가 0에서 1로 상승할때, level trigger는 신호가 한 상태를 일정시간 유지할 때 인터럽트를 발생시킨다. 트리거 설정에 2개의 bit가 사용되기 때문에 총 8개의 인터럽트에 대한 설정을 위해서 2개의 8비트 레지스터를 사용한다.
- EIMSK : 특정한 외부 인터럽트를 허용하는데 사용된다.

#### 버저, 타이머

jkit-128-1는 소리를 출력하기 위해서 1개의 버저를 달고 있으며 Port B의 4번 핀에 연결되어 있다. 버저를 이용해서 음계를 출력하기 위해서는 일정 시간동안 핀에 high, 그 다음 일정시간동안 low 신호를 인가하는 과정을 반복하면 된다. 특정 음계에 해당하는 파동의 주파수와 주기를 계산한뒤, 해당 음계의 주기의 절반에 해당하는 시간동안, high와 low를 출력하면 된다. 정확한 시간을 계산하기 위해서는 타이머를 이용할 수 있다.

타이머/카운터는 내부의 클록을 세거나, 특정 클럭의 파장을 만들어내는데 사용된다. ATmega128에서는 4개의 타이머/카운터를 제공한다.

- 타이머 0, 2 : 8비트 타이머
- 타이머 1, 3 : 16비트 타이머

ATmegq128의 클록 주파수는 16MHz이고, 주기는 62.5 ns 이다. 따라서 8비트 타이머로 256개의 클록을 센다고 하여도, 16&micro;s 밖에 세지 못한다. 이를 해결하기 위해서 프리스케일러를 사용할 수 있다. 프리스케일러란 클럭의 주파수를 특정한 분주비로 나누어서, 위에서 서술한 고속의 클럭이 갖는 문제점을 해결한다. 10비트 프리스케일러를 사용하면 최대 1024 분주된 클록을 사용할 수 있다.

타이머를 사용하기 위해서는 다음과 같은 레지스터를 적절히 설정해주어야 한다.

- TCCRn : 타이머의 분주비 설정
- TIMSK : 타이머를 오버플로우 인터럽트로 사용할 것인지, 출력 결과 비교로 사용할 것인지 설정
- TCNTn : 카운터할 클록 개수의 초기값. 8비트 타이머에서 x개의 클록을 세고 싶다면 이 레지스터에 256-x 값을 대입한다. 그러면 x 클록 이후에 오버플로우가 발생하여 인터럽트가 생성된다.

#### 조도센서와 AD컨버터

CdS 황화 카드뮴은 빛의 세기에 따라서 저항값이 달라지는 특성을 가지고 있다. 이를 통해 조도를 측정하는데 이용할 수 있다. 이 아날로그 값을 ATmega128에서 사용하기 위해서는 먼저 디지털 값으로 변환해야 한다. AD 컨버터는 측정하려는 물리량의 범위, 성질에 따라서 적절한 값을 설정한다. 분해능과 변환시간이라는 개념이 존재한다. 분해능은 변환된 디지털 값을 1 단위 증가시키기 위한 아날로그 값의 양을 뜻한다. 쉽게 말해서 측정할 수 있는 최소단위를 뜻한다.
